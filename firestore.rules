rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId
                          && isDataStructureValid(request.resource.data);
    }
  }
}

function isDataStructureValid(data) {
  return data.keys().hasAll([
    'userSelections', 'settings', 'allPlans', 'activePlanId', 
    'workoutHistory', 'personalRecords', 'currentView', 'savedTemplates'
  ])
  && data.userSelections.keys().hasAll([
    'goal', 'trainingAge', 'daysPerWeek', 'dietaryStatus', 'style', 'onboardingCompleted'
  ])
  && data.settings.keys().hasAll([
    'units', 'theme', 'progressionModel', 'weightIncrement', 'restDuration', 'haptics'
  ])
  && data.userSelections.goal is string
  && data.userSelections.trainingAge is string
  && data.userSelections.daysPerWeek is number
  && data.userSelections.onboardingCompleted is bool
  && data.settings.weightIncrement is number
  && data.settings.haptics is bool
  && (data.activePlanId is string || data.activePlanId == null)
  && data.allPlans is list
  && data.workoutHistory is list
  && data.personalRecords is list;
}

